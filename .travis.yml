language: elixir
cache:
  directories:
    - deps
    - _build
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
  apt:
    packages:
      - wkhtmltopdf
elixir:
  - 1.4.2
otp_release:
  - 19.2
env:
  global:
    - MIX_ENV=test
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    # Docker
    - DOCKER_HUB_ACCOUNT=edenlabllc
    - secure: "sK/G0Xf1vkNa+tYFU/zKqvuqupfd9xFRJoULXbC1THlOkP57W+Btt6pVRtKmn1L7ZTCf+QPHO/uNLuwzu5e7w5A4oQjiNDLQwVhsAa0C2w8LPW4ujJiBYec+Y0nGwZgreVVUAG5OAj3Cm2caibumN6u3Zxngu9vJ3uF/QyoFD9XYqVq48+o/ydabNieTgvHIhaw1vE0wF3kUzzqDAW2VgCtE1lFEd0wtuliUH9R0wztQSOqPIBD98ckJTxwFssFCLxQgpDYJvdHGi9uZxWeD5YLO7DAmZJDf6xs2QL90xUKivYBJ5qytbEoycTSVkgeYwF5bh0pdBno5u0qk5qPFeOi4jx+e8miugoLc2SMsTrH1G/dkkxbktNLB5cQhEPPxT6MWWFWuv9BZfp80slPDQ6W/e8+Q9Zzf9k8Si5nIPDRzBXSZ9FqUlJg7FtXBA9MCxUXHT4Hxjz6DDeO/fEHrRKuH1Ms6UVQBoQiMxsDpAvaTrcrQwV9AvJdVp1Txom3kotZ1UjJUTm9xQ8JVAlxEJ1pXYFVutMlKVOBcWLihl5SnbjdYW17Ilgu0QIVOuuy9mRtp1PXDC8uso5ZTegn3DhS/5UHP8DD+LcMkNLi74frozaAIGUFm0Lygx8vH/bkYG0+rqip5HoiHUldGOIN8G0mXJLMPNjLcArpr2tr46BE="
    # GitHub
    - secure: "W5+0Z3d45edOTpfqumZ+BjIO5RxCvNL+kP8MBZxOmPS2gUmCGyw7zj9RzaMMq2ipoUeInfD+yn2P4nND0qJt1Tv65+8Gs4wj1Y+onagurWUHLdvoeIMx5xgkTkHfxAH6bnmylCCRtmsneXqB+uyAuN4s96iVsdNGps3Y7ZXUI77lFcTL4DoojXB2oiuKkhvHckWD5AaJD2lRjx3Cc48snttwJbQoHj5yoe7PU8fqbIUAXd19O7crNlFnN/ujDcor276rHj8n6duin7xGE9DCmWGZC7aYyfWw9YMUM4axC6zqli3uj4Jzks0zZMkDN8M2Zcw497FiwdYSra7PcQOJV+skPbX4n2o8LcfG1jhyTchtpVEQueIgh/36E+F3DfPCzQI1d2ubJZCwSVcTqa3zD+ZKe0watkKJBeezAMhhJH19wUMBP6dYKmm9y5LcPX/FvIoqrVo7o+fxky4e4xzg9UisXqSg9s7/9iGBJSKnFG+rJIII0yIOV6JH0T86qYOvyq0oN2sJrfqcD2KKK9HmGtAuGnMpVWU8OcmT3QO/Ehc+P6ynV9v+01nT6Mp2lzX5+pRfhtvdfC6clBqdLsaneCIzWwhlcIlJ3cI9WJMULuv+3+0ovvqJItdIMFzMFTrPxGL4Q0EbdDVAlOu3pujU0fnnS1GII3+1Sj+ulHwDlqg="
    # Heroku
    - secure: "kE0xqy+D+0iKSi/FWlXYu6mADRhMk0OyiEuxOpUPrpLJ+VxlYpNeDQBf/AV6YpsNpE3X++9eo28Sc9AyFOrRGLPXHu2PUdUa/YsZp/TQOXckX1S+dy+jOR1NK/tkfSyG8+Fb6ekMqt5hBsMwC7r/2FJf0Ht658RwgiWIGI1a587OpmbSl2MAclwAsL8rWR8v7M6F+P1chIVfoyF2YnbhBmY7frcnqOSaXpqRGNS2+oqSDVJ3bUTINoT/tcN41hR5+7fC8pl+bOz1dPsDm9IpXEheK3fHIb0N7SAGV1qt9oEap9hCQ+eq3yxe7paR9enDok40Q86ch6N2uf3u6z3afqEKAAzfBB4hKd5WqT+8q9QIgvVapVciOzQ4VqwGGAHmZsKq5VUEdAmdi1/+T2YLcpz4/+OYomZ2boOmHKlS8y5c83PzwUfqp+0aeh9lwzYdJAEHBNzb7jGXUH+7vxQwvc4yaB+RKSwI4Ex+s2MDTmS99Ui18DvDuAxcdpG0uqvgi+2pT+DxCjlebuFUYgPK0IQtqJrbVZOsMlwUeQQyQoEQhjGtl3vfTYBOH8zDyOtHL2z5jyoA9J366cT6yOSOU85+mNyCeRdThCQ907dGxt6cj7hn9b94hhGvGABg4z527BvRQQlngyAbQr71UqyEUzx+QrJ0oFdEqhnputNtjr4="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Expose MQ and DB to Docker container
  - sudo ./bin/ci/init-db.sh
before_script:
  # Run X server to for wkhtmltopdf
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
script:
  # Increment version in mix.exs
  - ./bin/ci/version-increment.sh
  # Install dependencies
  - mix deps.get
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  # Add --pro if you using private repo.
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo --strict
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Initialize DB for Docker container
  - MIX_ENV=dev mix ecto.setup
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs man_api --details --since 5h;
      exit 1;
    fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/acceptance"
after_failure:
  - docker logs man_api --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
  - ./bin/ci/deploy.sh
